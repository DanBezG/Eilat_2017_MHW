---
title: "MHW_eilat_DBG"
author: "Dan Bez Golanski"
date: "2023-11-01"
output: html_document
---
#load packages
```{r warning=FALSE}
library(suntools)
library(tidyverse)
library(ggplot2)
library(dplyr)
```

#load data
```{r}
fish_df <-  readRDS("Renanel_raw.rds")
filter_fish <- read.csv("Valuble_fish.csv")
```

#filter valuble_fish and compute sampling time frequncies
```{r}
valuble_fish <- c(1255787,1255788,1255789,1255791,1255800,1255801,1255803,1255805,1255806,1255807,1255810,1255811,1255812,1255814,1255815)
fish_df <- fish_df %>% filter(fish_id %in% valuble_fish)
fish_df <- fish_df %>% arrange(fish_id,real_datetime)
fish_df$diff_samp_time <- NA
for (row_num in 2:dim(fish_df)[1]) {
    if (fish_df$fish_id[row_num]==fish_df$fish_id[row_num-1]) {
      if (fish_df$date[row_num]==fish_df$date[row_num-1]) {
        fish_df$diff_samp_time[row_num] <-     difftime(fish_df$real_datetime[row_num],fish_df$real_datetime[row_num-1],units = "secs")
      }  
      else {
        fish_df$diff_samp_time[row_num] <- NA
      }
    }
  else {
    fish_df$diff_samp_time[row_num] <- NA
  }
}
fish_samp_freq_df <- fish_df %>% group_by(fish_id,date) %>% 
  summarise(mean_freq = mean(diff_samp_time,na.rm = T), n = n())

```

#Add sunset.rise and Before.After
```{r}
filter_fish$real_datetime <- parse_date_time(filter_fish$real_datetime, orders = "ymd HMS")
heatwave_date <- parse_date_time("02-07-2017 00:00:00",orders = "dmy HMS")
#random coordiantes in eilat
filter_fish$sunrise <-sunriset(matrix(c(29.538417,34.954417),nrow=1), as.POSIXct(as.Date(filter_fish$datetime_GMT3),tz="IST"),direction = "sunrise", POSIXct.out = T)$time
filter_fish$sunset <-sunriset(matrix(c(29.538417,34.954417),nrow=1), as.POSIXct(as.Date(filter_fish$datetime_GMT3),tz="IST"),direction = "sunset", POSIXct.out = T)$time
for (row_num in 1:dim(filter_fish)[1]) {
    if(filter_fish$real_datetime[row_num]>heatwave_date)
    {
      filter_fish$Before_After[row_num] <- "After"
    }
    else
    {
      filter_fish$Before_After[row_num] <- "Before"
    }
   if (filter_fish$real_datetime[row_num] > filter_fish$sunrise[row_num] && filter_fish$real_datetime[row_num] < filter_fish$sunset[row_num]) 
    {
      filter_fish$Day_night[row_num]<-"Day"
    }
  else
    {
      filter_fish$Day_night[row_num]<-"Night"
    }
}

```

#save data
```{r}
write.csv(filter_fish,"Valuble_fish.csv")
saveRDS(filter_fish,"Valuble_fish.RDS")
```

#Graphs
```{r}
#activity
 activity_plot <- ggplot(filter_fish,aes(x=real_datetime,y=activity))+
  geom_point(size=0.6)+
  scale_x_datetime(date_breaks = "7 days",date_labels = "%d/%m/%y")+
  geom_smooth()+
  ylim(0,5)+
  facet_wrap(filter_fish$fish_id,ncol=1)
#depth
 depth_plot <- ggplot(filter_fish,aes(x=real_datetime,y=depth))+
  geom_point(size=0.6)+
  scale_x_datetime(date_breaks = "7 days",date_labels = "%d/%m/%y")+
  geom_smooth()+
  ylim(0,35)+
  facet_wrap(filter_fish$fish_id,ncol=1)

```